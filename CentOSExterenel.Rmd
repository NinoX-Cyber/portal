---
title: "CentOS 外接硬碟、手動核心編譯和驅動程式"
author: "teuton"
date: "7/2/2021"
output:
  bookdown::html_document2:
    toc: true
    toc_depth: 2
    number_sections: true
    theme: darkly
    highlight: espresso
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = FALSE)
```

# ContOS7 外接硬碟

仿照安裝 Windows 10 外接硬碟的方法，使用 Virtulbox 將作業系統安裝至外接硬碟，如果要安裝雙作業系統，建議先安裝 Windows 再安裝 CentOS7

## 前置作業

前往[CentOS 官網](https://www.centos.org/centos-linux/)下載 CentOS7 x86_64 的 iso 檔

下載[Virtualbox](https://www.virtualbox.org/wiki/Downloads)

如果有必要，就將外接硬碟的一部份切割成 exfat 格式，作為 CentOS 辨識的格式化區域和安裝位置

## 新增虛擬硬碟

在終端機輸入`diskutil list` 並尋找 external, physical 的磁區，以本例而言為 `/dev/disk2`

卸載你的外接硬碟，雃後輸入以下指令來建立一個名為 bootcampC 虛擬硬碟(記得把 `/dev/disk2` 換成你的位址)，看到成功訊息顯示就可以了

```{r}
sudo VBoxManage internalcommands createrawvmdk -filename bootcampC.vmdk -rawdisk /dev/disk2
```

## 新增虛擬機

以管理員身份執行 Virtualbox

```{r}
sudo /Applications/VirtualBox.app/Contents/MacOS/VirtualBox
```

新增一台虛擬機，類型為 Linux，版本為 Red Hat (64-bit)，選擇預設記憶體容量，使用現有虛擬硬碟檔案，點擊資料夾圖示，加入剛才建立的虛擬硬碟(預設在使用者的根目錄內)，選擇它，確認外接硬碟已卸載後建立

## 設定虛擬機

點擊剛才建立的虛擬機作設定

* 系統
  - 指標裝置: USB 平板電腦
  - 啟用 EFI
  - 關閉 UTC 硬體時鐘選項
* 存放裝置
  - 控制器 SATA: 使用主機 I/O 快取
  - 控制器 IDE:
    + 光碟機: 點擊右側藍色光碟圖示，選擇磁碟檔，選擇先前下載的 CentOS7 映像檔
    
完成設定後儲存並關閉 Virtualbbox，在終端機輸入以下指令來防止虛擬機自動重開機(將 CentOS7 換成你的虛擬機名稱)，這樣以後的安裝會方便些

```{r}
sudo VBoxManage setextradata CentOS7 "VBoxInternal/PDM/HaltOnReset" 1
```

## 進行 CentOS 初始化安裝

打開 Virtualbox

```{r}
sudo /Applications/VirtualBox.app/Contents/MacOS/VirtualBox
```

卸載外接硬碟後打開虛擬機，選擇 install CentOS 7，等到進入設定頁面後，選擇語言，進入主要設定

* 鍵盤配置: 新增漢語(Chewing)就能使用平常的中英文輸入法，預設的漢語可移除
* 軟體選擇: 本例使用 GNOME 桌面環境設置，並且附加基本開發工具
* 安裝目的地: 點進來之後直接按完成，系統會說你沒有足夠的空間，選擇取回空間，選擇你要安裝的磁區(先前切出的 exfat 磁區)按下清除，選擇它作為 CenntOS 的安裝位置，完成設定

以上設定完成後就可以開始安裝了，這段期間設定管理員密碼和新增使用者，在畫面顯示重開機時關閉此虛擬機

## 完成 CentOS 安裝

將電腦重新開機，這次開機時按住 option 鍵，就會進入開機硬碟選單，選擇 EFI Boot，你會看到二個選擇---CentOS Linux 3.10.\* 和 CentOS Linux 0-rescue-\*---選擇 0-rescue 選項，插入 USB 滑鼠和鍵盤，接受授權條款後完成安裝

打開終端機輸入 `sudo dracut -f` 指令，系統會將磁碟分割到完善的狀態，完成後將電腦關機，以後就能使用內核 3.10 版本的 CenntOS

## 手動編譯核心和驅動程式

### 前置作業

下載[核心原程式碼](https://www.kernel.org/)，本例使用 4.19.\* 版本

下載編譯核心所需要使用的工具套件，更確切的說，它們的 rpm 檔

* [kernel-devel](http://mirror.centos.org/centos/7/os/x86_64/Packages/kernel-devel-3.10.0-1160.el7.x86_64.rpm)
* [kernel-headers](http://mirror.centos.org/centos/7/os/x86_64/Packages/kernel-headers-3.10.0-1160.el7.x86_64.rpm)
* [ncurses-devel](http://mirror.centos.org/centos/7/os/x86_64/Packages/ncurses-devel-5.9-14.20130511.el7_4.x86_64.rpm)
* [flex](http://mirror.centos.org/centos/7/os/x86_64/Packages/flex-2.5.37-6.el7.x86_64.rpm)
  - [m4](http://mirror.centos.org/centos/7/os/x86_64/Packages/m4-1.4.16-10.el7.x86_64.rpm)
* [bison](http://mirror.centos.org/centos/7/os/x86_64/Packages/bison-3.0.4-2.el7.x86_64.rpm)
* [elfutils-libelf-devel](http://mirror.centos.org/centos/7/os/x86_64/Packages/elfutils-libelf-devel-0.176-5.el7.x86_64.rpm)
  - [zlib-devel](http://mirror.centos.org/centos/7/os/x86_64/Packages/zlib-devel-1.2.7-18.el7.x86_64.rpm)
* [gcc](http://mirror.centos.org/centos/7/os/x86_64/Packages/gcc-4.8.5-44.el7.x86_64.rpm)
  - [cpp](http://mirror.centos.org/centos/7/os/x86_64/Packages/cpp-4.8.5-44.el7.x86_64.rpm)
  - [glibc](http://mirror.centos.org/centos/7/os/x86_64/Packages/glibc-devel-2.17-317.el7.x86_64.rpm)
    + [glibc-headers](http://mirror.centos.org/centos/7/os/x86_64/Packages/glibc-headers-2.17-317.el7.x86_64.rpm)
* [openssl-devel](http://mirror.centos.org/centos/7/os/x86_64/Packages/openssl-devel-1.0.2k-19.el7.x86_64.rpm)
  - [krb5-devel](http://mirror.centos.org/centos/7/os/x86_64/Packages/krb5-devel-1.15.1-50.el7.x86_64.rpm)
    + [keyutils-libs-devel](http://mirror.centos.org/centos/7/os/x86_64/Packages/keyutils-libs-devel-1.5.8-3.el7.x86_64.rpm)
    + [libcom_err-devel](http://mirror.centos.org/centos/7/os/x86_64/Packages/libcom_err-devel-1.42.9-19.el7.x86_64.rpm)
    + [libverto-devel](http://mirror.centos.org/centos/7/os/x86_64/Packages/libverto-devel-0.2.5-4.el7.x86_64.rpm)
    + [libselinux-devel](http://mirror.centos.org/centos/7/os/x86_64/Packages/libselinux-devel-2.5-15.el7.x86_64.rpm)
      * [libsepol-devel](http://mirror.centos.org/centos/7/os/x86_64/Packages/libsepol-devel-2.5-10.el7.x86_64.rpm)
      * [pcre-devel](http://mirror.centos.org/centos/7/os/x86_64/Packages/pcre-devel-8.32-17.el7.x86_64.rpm)
  
## 安裝必要套件與配置

將核心原程式碼解壓縮後放置於 `/usr/src/kernels` 資料夾內，將所有 rpm 檔案依照順序安裝

```{r}
sudo rpm -ivh /PATH/FILE_NAME.RPM
```

將工作目錄移至新核心資料夾內，將現有組態檔複製到這裏備用

```{r}
cd /usr/src/kernels/linnux-4.19.*
sudo cp -v /boot/config-$(uname -r) .config
```

## 選擇編譯核心模組和驅動程式

使用以下指令進入核心組態設定

```{r}
sudo make menuconfig
```

以下為本例額外新增的模組

* Device Drivers
  -Network device support
    + Ethernet driver support
      * Broadcom GENET innternnal MAC support
      * Broadcom SYSTEMPORT internal MAC support
      * Thunder MAC interface driver (BGX)
      * D-Link devices
    + Wireless LAN
      * Broadcom 43xx wireless support (mac80211 stack)
      * Broadcom 43xx-legacy wireless support (mac80211 stack)
      * RTL8723AU/RTL8188[CR]U/RTL819[12]CU (mac80211) support
  - SPI support
    + PXA2xx SSP SPI master

完成後儲存成 `.config` 檔

## 編譯和安裝核心

執行 `sudo make` 就能開始編譯核心，這個步驟大約會花費兩個小時，接著執行 `sudo make modules_install` 就能安裝核心模組，完成後再執行 `sudo make install` 進行核心的安裝，重新開機後，你就能看到 grub 選單新增了剛才安裝的新核心

## Broadcom BCM43602 802.11ac [14e4:43ba] 驅動方法

在終端機輸入以下指令來確認網卡類型

```{r}
lspci -nn | grep Net
```

以本例而言為 BCM43602，前往[此處](https://bugzilla.kernel.org/attachment.cgi?id=285753)下載驅動文字檔，將其放置在 `/lib/firmware/brcm/` 內，輸入以下指令確認 mac 位址，本例為 00:90:4c:0d:f4:3e

```{r}
ip addr | grep ether
```

修改剛才放置的文字檔的三個參數

* macaddr=00:90:4c:0d:f4:3e
* ccode=0
* regrev=0

重新開機，現在你應該可以連線了

## macbook 鍵盤驅動

在安裝 PXA2xx SSP SPI master 核心模組之後，照理說 mac 鍵盤和觸控板就能使用了，如果還不行，下載[這裏](https://github.com/cb22/macbook12-spi-driver)的資料夾，用 `sudo make` 和 `sudo make innstall` 安裝，重新編譯核心和安裝後重新開機(核心只有第一次編譯非常花時間)

## macbook touchbar驅動

下載[這裏](https://github.com/roadrunner2/macbook12-spi-driver)的資料夾，用 `sudo make` 和 `sudo make innstall` 安裝，重新編譯核心和安裝後重新開機
